<!DOCTYPE html>
<html>
<head>
    <title>MilestoneStatusApp</title>

    <script type="text/javascript" src="https://rally1.rallydev.com/apps/2.0/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                var types=Ext.data.Types;Ext.define("MilestoneTreeModel",{extend:"Ext.data.TreeModel",fields:[{name:"FormattedID",mapping:"FormattedID",type:types.STRING},{name:"Name",mapping:"Name",type:types.STRING},{name:"TargetDate",mapping:"AcceptedDate",type:types.DATE},{name:"TargetProject",mapping:"TargetProject",type:types.OBJECT},{name:"ValueStream",mapping:"ValueStream",type:types.STRING},{name:"Visibility",mapping:"Visibility",type:types.STRING},{name:"Status",mapping:"Status",type:types.STRING},{name:"DisplayColor",mapping:"DisplayColor",type:types.STRING},{name:"Notes",mapping:"Notes",type:types.STRING}],hasMany:{model:"FeatureTreeModel",name:"features",associationKey:"features"}}),Ext.define("CustomApp",{extend:"Rally.app.App",componentCls:"app",getSettingsFields:function(){return[{name:"notesFilter",xtype:"rallytextfield",fieldLabel:"Notes Filter"},{name:"showNumberOfMonths",xtype:"rallynumberfield",fieldLabel:"Date Range (months)"},{name:"includeGlobalMilestones",xtype:"rallycheckboxfield",fieldLabel:"",boxLabel:"Include global milestones"},{name:"groupByValueStream",xtype:"rallycheckboxfield",fieldLabel:"",boxLabel:"Group by Value Stream"}]},launch:function(){this._getAllChildProjectsForCurrentProject(this.project)},_getAllChildProjectsForCurrentProject:function(currProject){Ext.getBody().mask("Loading..."),this.allProjectsList=[];var that=this,projectStore=Ext.create("Rally.data.wsapi.Store",{model:"Project",fetch:["Name","State","Parent","Children"],autoLoad:!0,compact:!1,context:{workspace:that.getContext().getWorkspace()._Ref,projectScopeUp:!1,projectScopeDown:!0},limit:1/0,filters:[{property:"State",operator:"=",value:"Open"}],sorters:[{property:"Name",direction:"ASC"}],listeners:{load:function(projectStore,data,success){this.requiredProjectsList=[],this.allProjectsColl=data;var selectedProj=this.getContext().getProject(),selectedProjRef="/project/"+selectedProj.ObjectID;this.requiredProjectsList.push(selectedProj.ObjectID);var selectedProjChildren=selectedProj.Children;selectedProjChildren&&selectedProjChildren.Count>0&&this._loadAllChildProjectsFromParent(selectedProjRef),this._createMilestoneStoreFilter(),this._createMilestoneStore(),Ext.getBody().unmask()},scope:this}})},_loadAllChildProjectsFromParent:function(parentProjRef){var that=this;Ext.Array.each(this.allProjectsColl,function(thisProject){if(thisProject.get("Parent")&&null!==thisProject.get("Parent")._ref&&thisProject.get("Parent")._ref==parentProjRef){that.requiredProjectsList.push(thisProject.data.ObjectID);var projChildren=thisProject.get("Children");projChildren&&projChildren.Count>0&&that._loadAllChildProjectsFromParent(thisProject.get("_ref"))}})},_createMilestoneStoreFilter:function(){if(this.projectMilestoneFilter=Ext.create("Rally.data.wsapi.Filter",{property:"TargetDate",operator:">=",value:"today"}),this.getSetting("includeGlobalMilestones")&&(this.projectMilestoneFilter=this.projectMilestoneFilter.or(Ext.create("Rally.data.wsapi.Filter",{property:"TargetProject",operator:"=",value:"NULL"}))),this.getSetting("notesFilter")&&(this.projectMilestoneFilter=this.projectMilestoneFilter.and(Ext.create("Rally.data.wsapi.Filter",{property:"Notes",operator:"contains",value:this.getSetting("notesFilter")}))),this.getSetting("showNumberOfMonths")&&this.getSetting("showNumberOfMonths")>0){var endDate=Rally.util.DateTime.add(new Date,"month",this.getSetting("showNumberOfMonths"));this.projectMilestoneFilter=this.projectMilestoneFilter.and(Ext.create("Rally.data.wsapi.Filter",{property:"TargetDate",operator:"<=",value:endDate}))}},_createMilestoneStore:function(){var that=this,myStore=Ext.create("Rally.data.wsapi.Store",{model:"milestone",autoLoad:!0,compact:!1,listeners:{load:function(store,data,success){this._filterMileStones(data)},scope:this},filters:this.projectMilestoneFilter,sorters:[{property:"TargetProject",direction:"ASC"},{property:"TargetDate",direction:"ASC"}]})},_filterMileStones:function(myData){var that=this,filteredMilestonesArr=[];Ext.each(myData,function(data,index){that.getSetting("includeGlobalMilestones")&&null===data.data.TargetProject?filteredMilestonesArr.push(data):null!==data.data.TargetProject&&""!==data.data.TargetProject&&that.requiredProjectsList.indexOf(data.data.TargetProject.ObjectID)>-1&&filteredMilestonesArr.push(data)}),console.log("Filtered Milestone length : "+filteredMilestonesArr.length),this._organiseMilestoneBasedOnValuestream(filteredMilestonesArr)},_organiseMilestoneBasedOnValuestream:function(filteredMilestonesArr){this.valueStreamMilestoneColl=[],this.valueStreamColl=[];var nonVSCount=0,that=this;Ext.Array.each(filteredMilestonesArr,function(thisData){var valuestream=that._getValueStream(thisData);""!==valuestream?0===that.valueStreamColl.length?that.valueStreamColl.push(valuestream):that.valueStreamColl.length>0&&-1===that.valueStreamColl.indexOf(valuestream)&&that.valueStreamColl.push(valuestream):nonVSCount++}),this.valueStreamColl.sort(),nonVSCount>0&&this.valueStreamColl.push("NA"),console.log("ValueStream collection: ",this.valueStreamColl),Ext.Array.each(this.valueStreamColl,function(valuestream){var milestoneColl=that._getAllAssociatedMilestones(valuestream,filteredMilestonesArr);that.valueStreamMilestoneColl.push({key:valuestream,value:milestoneColl})}),console.log("ValueStream Milestone collection: ",this.valueStreamMilestoneColl),this._createValueStreamMilestonesTreeNode()},_createValueStreamMilestonesTreeNode:function(){var valueStreamRootNode=Ext.create("MilestoneTreeModel",{Name:"ValueStream Root",text:"ValueStream Root",root:!0,expandable:!0,expanded:!0});this._createValueStreamNodesAlongWithAssociatedChildMilestoneNodes(valueStreamRootNode),console.log("Valuestream Milestone Tree Node: ",valueStreamRootNode),this._createValueStreamMilestoneGrid(valueStreamRootNode)},_createValueStreamMilestoneGrid:function(valueStreamRootNode){var milestoneValueStreamTreeStore=Ext.create("Ext.data.TreeStore",{model:"MilestoneTreeModel",root:valueStreamRootNode}),valuestreamMilestoneTreePanel=Ext.create("Ext.tree.Panel",{store:milestoneValueStreamTreeStore,useArrows:!0,lines:!0,displayField:"Name",rootVisible:!1,width:"100%",height:"auto",plugins:["cellediting","gridviewdragdrop"],columns:[{xtype:"treecolumn",text:"Name",dataIndex:"Name",resizeable:!0,width:300,renderer:function(value,style,item,rowIndex){var link=Ext.String.format("{0}",value);return-1===link.search("valuestream:")&&(link=Ext.String.format("<a target='_top' href='{1}'>{0}</a>",value,Rally.nav.Manager.getDetailUrl(item))),link}},{text:"Project",dataIndex:"TargetProject",width:300},{text:"Target Date",dataIndex:"TargetDate",width:100,renderer:function(value){return value?Rally.util.DateTime.format(value,"M Y"):void 0}},{text:"Color",dataIndex:"DisplayColor",width:100},{text:"Notes",dataIndex:"Notes",width:500}]});this.add(valuestreamMilestoneTreePanel)},_createValueStreamNodesAlongWithAssociatedChildMilestoneNodes:function(valustreamRootNode){var that=this;Ext.Array.each(this.valueStreamMilestoneColl,function(thisData){var valueStreamNode=that._createValueStreamNode(thisData.key);Ext.Array.each(thisData.value,function(thisMilestoneData){var milestoneNode=that._createMilestoneNode(thisMilestoneData);valueStreamNode.appendChild(milestoneNode)}),valustreamRootNode.appendChild(valueStreamNode)})},_createValueStreamNode:function(valuestreamData){var valueStreamLable="valuestream: "+valuestreamData,valustreamTreeNode=Ext.create("MilestoneTreeModel",{Name:valueStreamLable,leaf:!1,expandable:!0,expanded:!1,iconCls:".ico-test-valustream"});return valustreamTreeNode},_createMilestoneNode:function(milestoneData){var targetProjectName=null!==milestoneData.get("TargetProject")?milestoneData.get("TargetProject")._refObjectName:"Global",milestoneTreeNode=Ext.create("MilestoneTreeModel",{FormattedID:milestoneData.get("FormattedID"),Name:milestoneData.get("Name"),TargetDate:milestoneData.get("TargetDate"),TargetProject:targetProjectName,DisplayColor:milestoneData.get("DisplayColor"),Notes:milestoneData.get("Notes"),leaf:!0,expandable:!1,expanded:!1,iconCls:".ico-test-milestone"});return milestoneTreeNode},_getAllAssociatedMilestones:function(valuestream,milestoneStoreData){var milestoneColl=[],that=this;return Ext.Array.each(milestoneStoreData,function(milestone){var vsRecord=that._getValueStream(milestone);vsRecord=""!==vsRecord?vsRecord:"NA",vsRecord===valuestream&&milestoneColl.push(milestone)}),milestoneColl},_getValueStream:function(record){var notes=record.get("Notes");if(!notes||0>=notes.length)return"";var indexForValueStream=notes.indexOf("valuestream:");if(-1===indexForEndOfValueStream)return"";var valueStreamText=notes.slice(indexForValueStream,notes.length),indexForEndOfValueStream=valueStreamText.indexOf("<"),valueStream=valueStreamText.slice(valueStreamText.indexOf(":")+1,indexForEndOfValueStream);return valueStream}});

            Rally.launchApp('CustomApp', {
                name:"MilestoneStatusApp",
	            parentRepos:""
            });

        });
    </script>


    <style type="text/css">
        .ico-test-valustream{width:15px;height:15px;background-image:url('https://cdn0.iconfinder.com/data/icons/frankfurt/16/featured.png') !important}.ico-test-milestone{width:15px;height:15px;background-image:url('https://cdn2.iconfinder.com/data/icons/blue-bits-basic-and-bonus/16/057.png') !important}
    </style>
</head>
<body>
</body>
</html>
