<!DOCTYPE html>
<html>
<head>
    <title>MilestoneStatusApp</title>

    <script type="text/javascript" src="/apps/2.0/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                var types=Ext.data.Types;Ext.define("MilestoneTreeModel",{extend:"Ext.data.TreeModel",fields:[{name:"FormattedID",mapping:"FormattedID",type:types.STRING},{name:"Name",mapping:"Name",type:types.STRING},{name:"TargetDate",mapping:"AcceptedDate",type:types.DATE},{name:"TargetProject",mapping:"TargetProject",type:types.OBJECT},{name:"ValueStream",mapping:"ValueStream",type:types.STRING},{name:"Visibility",mapping:"Visibility",type:types.STRING},{name:"Status",mapping:"Status",type:types.STRING},{name:"DisplayColor",mapping:"DisplayColor",type:types.STRING},{name:"Notes",mapping:"Notes",type:types.STRING},{name:"_ref",mapping:"_ref",type:types.STRING},{name:"AcceptedLeafStoryCount",mapping:"AcceptedLeafStoryCount",type:types.STRING},{name:"LeafStoryCount",mapping:"LeafStoryCount",type:types.STRING}],hasMany:{model:"FeatureTreeModel",name:"features",associationKey:"features"}}),Ext.define("MilestoneDataModel",{extend:"Ext.data.Model",fields:[{name:"FormattedID",mapping:"FormattedID",type:types.STRING},{name:"Name",mapping:"Name",type:types.STRING},{name:"TargetDate",mapping:"AcceptedDate",type:types.DATE},{name:"TargetProject",mapping:"TargetProject",type:types.OBJECT},{name:"ValueStream",mapping:"ValueStream",type:types.STRING},{name:"Visibility",mapping:"Visibility",type:types.STRING},{name:"Status",mapping:"Status",type:types.STRING},{name:"DisplayColor",mapping:"DisplayColor",type:types.STRING},{name:"Notes",mapping:"Notes",type:types.STRING},{name:"_ref",mapping:"_ref",type:types.STRING},{name:"AcceptedLeafStoryCount",mapping:"AcceptedLeafStoryCount",type:types.INT},{name:"LeafStoryCount",mapping:"LeafStoryCount",type:types.INT}]}),Ext.define("CustomApp",{extend:"Rally.app.App",componentCls:"app",getSettingsFields:function(){return[{name:"executiveVisibilityOnly",xtype:"rallycheckboxfield",fieldLabel:"",boxLabel:"Only show Milestones with Executive Visibility"},{name:"includeGlobalMilestones",xtype:"rallycheckboxfield",fieldLabel:"",boxLabel:"Include global milestones"},{name:"showNumberOfMonths",xtype:"rallynumberfield",fieldLabel:"Date Range (months)"}]},launch:function(){this._getAllChildProjectsForCurrentProject(this.project)},_getAllChildProjectsForCurrentProject:function(currProject){Ext.getBody().mask("Loading..."),this.allProjectsList=[];var that=this,projectStore=Ext.create("Rally.data.wsapi.Store",{model:"Project",fetch:["Name","State","Parent","Children"],autoLoad:!0,compact:!1,context:{workspace:that.getContext().getWorkspace()._Ref,projectScopeUp:!1,projectScopeDown:!0},limit:1/0,filters:[{property:"State",operator:"=",value:"Open"}],sorters:[{property:"Name",direction:"ASC"}],listeners:{load:function(projectStore,data,success){this.requiredProjectsList=[],this.allProjectsColl=data;var selectedProj=this.getContext().getProject(),selectedProjRef="/project/"+selectedProj.ObjectID;this.requiredProjectsList.push(selectedProj.ObjectID);var selectedProjChildren=selectedProj.Children;selectedProjChildren&&selectedProjChildren.Count>0&&this._loadAllChildProjectsFromParent(selectedProjRef),this._createMilestoneStoreFilter(),this._createMilestoneStore()},scope:this}})},_loadAllChildProjectsFromParent:function(parentProjRef){var that=this;Ext.Array.each(this.allProjectsColl,function(thisProject){if(thisProject.get("Parent")&&null!==thisProject.get("Parent")._ref&&thisProject.get("Parent")._ref==parentProjRef){that.requiredProjectsList.push(thisProject.data.ObjectID);var projChildren=thisProject.get("Children");projChildren&&projChildren.Count>0&&that._loadAllChildProjectsFromParent(thisProject.get("_ref"))}})},_createMilestoneStoreFilter:function(){if(this.projectMilestoneFilter=Ext.create("Rally.data.wsapi.Filter",{property:"TargetDate",operator:">=",value:"today"}),this.getSetting("executiveVisibilityOnly")&&(this.projectMilestoneFilter=this.projectMilestoneFilter.and(Ext.create("Rally.data.wsapi.Filter",{property:"c_ExecutiveVisibility",operator:"=",value:this.getSetting("executiveVisibilityOnly")}))),this.getSetting("showNumberOfMonths")&&this.getSetting("showNumberOfMonths")>0){var endDate=Rally.util.DateTime.add(new Date,"month",this.getSetting("showNumberOfMonths"));this.projectMilestoneFilter=this.projectMilestoneFilter.and(Ext.create("Rally.data.wsapi.Filter",{property:"TargetDate",operator:"<=",value:endDate}))}},_createMilestoneStore:function(){Ext.create("Rally.data.wsapi.Store",{model:"milestone",autoLoad:!0,compact:!1,listeners:{load:function(store,data,success){this._filterMileStones(data)},scope:this},filters:this.projectMilestoneFilter,sorters:[{property:"c_ValueStream",direction:"ASC"},{property:"TargetDate",direction:"ASC"}]})},_filterMileStones:function(milestones){var that=this,filteredMilestonesArr=[];Ext.each(milestones,function(milestone,index){null!==milestone.data.TargetProject&&""!==milestone.data.TargetProject&&that.requiredProjectsList.indexOf(milestone.data.TargetProject.ObjectID)>-1&&filteredMilestonesArr.push(milestone),that.getSetting("includeGlobalMilestones")&&null===milestone.data.TargetProject&&filteredMilestonesArr.push(milestone)}),this._loadArtifactsForMilestones(filteredMilestonesArr)},_loadArtifactsForMilestones:function(milestoneArr){var that=this;this.milestoneNameList=this._getListOfMilestoneNames(milestoneArr),this._loadArtifacts(that.milestoneNameList).then({success:function(records){var me=that;that.milestoneDataArray=[],Ext.Array.each(records,function(record,index){var storyCountInfo=me._computeArtifactsAssociation(record),milestoneRec=milestoneArr[index],milestoneCustomData=me._createCustomMilestoneData(milestoneRec,storyCountInfo);me.milestoneDataArray.push(milestoneCustomData)}),that._organiseMilestoneBasedOnValuestream(that.milestoneDataArray)},failure:function(error){console.log("There are some errors"),Ext.getBody().unmask()}})},_createCustomMilestoneData:function(milestoneItem,storyCountInfo){var milestoneData=Ext.create("MilestoneDataModel",{FormattedID:milestoneItem.get("FormattedID"),Name:milestoneItem.get("Name"),TargetDate:milestoneItem.get("TargetDate"),TargetProject:milestoneItem.get("Name"),ValueStream:milestoneItem.get("c_ValueStream"),Visibility:milestoneItem.get("c_ExecutiveVisibility"),Status:milestoneItem.get("c_Test"),DisplayColor:milestoneItem.get("DisplayColor"),Notes:milestoneItem.get("Notes"),_ref:milestoneItem.get("_ref"),AcceptedLeafStoryCount:storyCountInfo.acceptedCount,LeafStoryCount:storyCountInfo.storyCount});return milestoneData},_getListOfMilestoneNames:function(milestones){var namelist=[];return Ext.Array.each(milestones,function(milestone){var name=milestone.get("Name");-1===namelist.indexOf(name)&&namelist.push(name)}),namelist},_loadArtifacts:function(milestoneList){var promises=[],that=this;return Ext.Array.each(milestoneList,function(milestone){var artifactStore=Ext.create("Rally.data.wsapi.artifact.Store",{models:["portfolioitem/feature","defect","userstory"],context:{workspace:that.getContext().getWorkspace()._Ref,limit:1/0,projectScopeUp:!1,projectScopeDown:!0},filters:[{property:"Milestones.Name",operator:"=",value:milestone}]});promises.push(that._loadArtifactStore(artifactStore))}),Deft.Promise.all(promises)},_loadArtifactStore:function(store){var deferred;return deferred=Ext.create("Deft.Deferred"),store.load({callback:function(records,operation,success){success?deferred.resolve(records):deferred.reject("Error loading Companies.")}}),deferred.promise},_computeArtifactsAssociation:function(artifactColl){var storyCountInfo={storyCount:0,acceptedCount:0},leafStoryCount=0,acceptedLeafStoryCount=0;return Ext.Array.each(artifactColl,function(item){var itemType=item.get("_type"),scheduleState=item.get("ScheduleState");"hierarchicalrequirement"==itemType||"defect"==itemType?(leafStoryCount+=1,"Accepted"==scheduleState&&(acceptedLeafStoryCount+=1)):(leafStoryCount+=item.get("LeafStoryCount"),acceptedLeafStoryCount+=item.get("AcceptedLeafStoryCount"))}),storyCountInfo.storyCount=leafStoryCount,storyCountInfo.acceptedCount=acceptedLeafStoryCount,storyCountInfo},_organiseMilestoneBasedOnValuestream:function(filteredMilestonesArr){this.valueStreamMilestoneColl=[],this.valueStreamColl=[];var nonVSCount=0,that=this;Ext.Array.each(filteredMilestonesArr,function(thisData){var valuestream=thisData.get("ValueStream");null!==valuestream&&""!==valuestream?0===that.valueStreamColl.length?that.valueStreamColl.push(valuestream):that.valueStreamColl.length>0&&-1===that.valueStreamColl.indexOf(valuestream)&&that.valueStreamColl.push(valuestream):nonVSCount++}),this.valueStreamColl.sort(),nonVSCount>0&&this.valueStreamColl.push("N/A"),Ext.Array.each(this.valueStreamColl,function(valuestream){var milestoneColl=that._getAllAssociatedMilestones(valuestream,filteredMilestonesArr);that.valueStreamMilestoneColl.push({key:valuestream,value:milestoneColl})}),this._createValueStreamMilestonesTreeNode()},_createValueStreamMilestonesTreeNode:function(){var valueStreamRootNode=Ext.create("MilestoneTreeModel",{Name:"ValueStream Root",text:"ValueStream Root",root:!0,expandable:!0,expanded:!0});this._createValueStreamNodesAlongWithAssociatedChildMilestoneNodes(valueStreamRootNode),this._createValueStreamMilestoneGrid(valueStreamRootNode)},_createValueStreamMilestoneGrid:function(valueStreamRootNode){var milestoneValueStreamTreeStore=Ext.create("Ext.data.TreeStore",{model:"MilestoneTreeModel",root:valueStreamRootNode}),valuestreamMilestoneTreePanel=Ext.create("Ext.tree.Panel",{store:milestoneValueStreamTreeStore,useArrows:!0,rowLines:!0,displayField:"Name",rootVisible:!1,width:this.getWidth(!0),height:this.getHeight(!0),viewConfig:{getRowClass:function(record,index){var nameRecord=Ext.String.format("{0}",record.get("Name"));return nameRecord&&-1===nameRecord.search("valuestream:")?"row-child":"row-parent"}},columns:[{xtype:"treecolumn",text:"Name",dataIndex:"Name",resizeable:!0,flex:3,minWidth:200,renderer:function(value,style,item,rowIndex){var link=Ext.String.format("{0}",value);if(-1===link.search("valuestream:")){var ref=item.get("_ref");link=Ext.String.format("<a target='_top' href='{1}'><b>{0}</b></a>",value,Rally.nav.Manager.getDetailUrl(ref))}else{var onlyName=link.replace("valuestream:","");link=Ext.String.format("<b>{0}</b>",onlyName)}return link}},{text:"Project",dataIndex:"TargetProject",flex:2,hidden:!0},{text:"Target Date",dataIndex:"TargetDate",flex:1,renderer:function(value){return value?Rally.util.DateTime.format(value,"M Y"):void 0}},{text:"Accepted Count",dataIndex:"AcceptedLeafStoryCount",flex:1},{text:"Story Count",dataIndex:"LeafStoryCount",flex:1},{text:"Status",dataIndex:"DisplayColor",flex:1,renderer:function(value){if(value){var colorHtml=Ext.String.format("<div class= 'color-box' style= 'background-color: {0};'></div>",value);return colorHtml}}},{text:"Notes",dataIndex:"Notes",flex:5}]});this.add(valuestreamMilestoneTreePanel),Ext.getBody().unmask()},_createValueStreamNodesAlongWithAssociatedChildMilestoneNodes:function(valustreamRootNode){var that=this;Ext.Array.each(this.valueStreamMilestoneColl,function(thisData){var valueStreamNode=that._createValueStreamNode(thisData.key);Ext.Array.each(thisData.value,function(thisMilestoneData){var milestoneNode=that._createMilestoneNode(thisMilestoneData);valueStreamNode.appendChild(milestoneNode)}),valustreamRootNode.appendChild(valueStreamNode)})},_createValueStreamNode:function(valuestreamData){var valueStreamLable="valuestream: "+valuestreamData,valustreamTreeNode=Ext.create("MilestoneTreeModel",{Name:valueStreamLable,AcceptedLeafStoryCount:"",LeafStoryCount:"",leaf:!1,expandable:!0,expanded:!0,iconCls:"no-icon"});return valustreamTreeNode},_createMilestoneNode:function(milestoneData){var targetProjectName=null!==milestoneData.get("TargetProject")?milestoneData.get("TargetProject")._refObjectName:"Global",milestoneTreeNode=Ext.create("MilestoneTreeModel",{FormattedID:milestoneData.get("FormattedID"),Name:milestoneData.get("Name"),TargetDate:milestoneData.get("TargetDate"),TargetProject:targetProjectName,DisplayColor:milestoneData.get("DisplayColor"),Notes:milestoneData.get("Notes"),_ref:milestoneData.get("_ref"),AcceptedLeafStoryCount:""+milestoneData.get("AcceptedLeafStoryCount"),LeafStoryCount:""+milestoneData.get("LeafStoryCount"),leaf:!0,expandable:!1,expanded:!1,iconCls:"no-icon"});return milestoneTreeNode},_getAllAssociatedMilestones:function(valuestream,milestoneStoreData){var milestoneColl=[],that=this;return Ext.Array.each(milestoneStoreData,function(milestone){var vsRecord=milestone.get("ValueStream");vsRecord=null!==vsRecord&&""!==vsRecord?vsRecord:"N/A",vsRecord===valuestream&&milestoneColl.push(milestone)}),milestoneColl}});

            Rally.launchApp('CustomApp', {
                name:"MilestoneStatusApp",
	            parentRepos:""
            });

        });
    </script>


    <style type="text/css">
        .ico-test-valustream{width:20px;height:20px;top:8px;background-image:url('https://cdn4.iconfinder.com/data/icons/stash/128/ruby-16.png') !important}.ico-test-milestone{width:20px;height:20px;top:8px;background-image:url('https://cdn1.iconfinder.com/data/icons/all_google_icons_symbols_by_carlosjj-du/16/milestone.png') !important}.color-box{width:15px;height:15px;display:inline-block;background-color:#ccc;position:relative;left:10px;top:0px}.no-icon{display:none;background-image:url('ext/resources/images/default/s.gif') !important}.row-parent .x-grid-cell{background-color:#77D38D !important}.x-grid-item-over .row-parent .x-grid-cell{background-color:#3da5f5 !important}.x-grid-item-selected .row-parent .x-grid-cell{background-color:#ff0 !important}.row-child .x-grid-cell{background-color:#FFFFFF !important}.x-grid-item-over .row-child .x-grid-cell{background-color:#C2FABA !important}.x-grid-item-selected .row-child .x-grid-cell{background-color:#80AA79 !important}
    </style>
</head>
<body>
</body>
</html>
